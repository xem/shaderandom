<meta charset=utf-8>
<body style="margin: 0; font-size: 10px; font-family: monospace;">
<pre id=p></pre>
<canvas id=a width=640 height=360 style="width:99%; height: 85%"></canvas>
<script>
  /**  Random WebGL Fragment Shader Generator **/
  
  // The fragment sets gl_FragColor
  seed = "fragColor = VEC4;";
  
  // Different ways to produce a vec4
  VEC4 = ["vec4(EXPF, EXPF, EXPF, EXPF)", /*"(VEC4 * EXP)", "(VEC4 / EXP)", "(VEC4 + VEC4)", "(VEC4 - VEC4)",*/ "FUNC1TTO1T(VEC4)", "FUNC2TTO1T(VEC4, VEC4)"];
  
  // Expressions producing a float or a vec4
  EXP = ["EXPF", "VEC4"];
  
  // Expressions producing a float
  EXPF = ["FUNC1TTO1T(EXPF)", "FUNC2TTO1T(EXPF, EXPF)", "(EXPF + EXPF)", "(EXPF - EXPF)", "(EXPF * EXPF)", "(EXPF / EXPF)", "iGlobalTime", "float(iFrame)", "(gl_FragCoord.x / iResolution.x)", "(gl_FragCoord.y / iResolution.y)", "FLOAT"];
  
  // Functions transforming 1 thing (float / vec) into 1 thing
  FUNC1TTO1T = ["radians", "degrees", "sin", "cos", "tan", "asin", "acos", "atan", "exp", "log", "exp2", "log2", "sqrt", "inversesqrt", "abs", "sign", "floor", "ceil", "fract", "normalize"];
  
  // Functions transforming 2 things into 1 thing
  FUNC2TTO1T = ["atan", "pow", "mod", "min", "max", "step", "reflect"];

  pick = function(arr){
    return arr[Math.floor(Math.random()*arr.length)];
  }

  onload = generate = function(){
    oldseed = seed;
    seed = seed.replace(/VEC4/g, function(){return pick(VEC4)});
    seed = seed.replace(/EXPF/g, function(){return (Math.random() > 0.5 ? pick(EXPF) : "FLOAT")});
    seed = seed.replace(/EXP(?!F)/g, function(){return pick(EXP)});
    seed = seed.replace(/FUNC1TTO1T/g, function(){return pick(FUNC1TTO1T)});
    seed = seed.replace(/FUNC2TTO1T/g, function(){return pick(FUNC2TTO1T)});
    seed = seed.replace(/FLOAT/g, function(){return Math.floor(Math.random()*2) + "." + Math.floor(Math.random()*10)});

    // Reset seed if it's too simple or too long
    if(seed .length < 50 || seed.length > 10000){
      seed = "fragColor = VEC4;";
    }
    
    // Write to page
    p.innerHTML = "<pre>void mainImage(out vec4 fragColor, in vec2 fragCoord){" + seed + "}";
    if(oldseed != seed || seed == "fragColor = VEC4;"){
      setTimeout(generate);
    }
    
    // End of the random generation: shader preview
    else{
    
      /** Shadertoy-compatible shader preview **/
      
      
      // Get canvas WebGL context
      g=a.getContext("webgl");

      // Define a new program
      P=g.createProgram();

      // Basic vertex shader
      g.shaderSource(S=g.createShader(g.VERTEX_SHADER),"attribute vec2 P;void main(){gl_Position=vec4(P,0,1);}");

      // Compile and attach it to the program
      g.compileShader(S);
      g.attachShader(P,S);
      
      // Main program
      console.log("precision mediump float;uniform float iGlobalTime, iFrame;uniform vec2 iResolution;void main(){"+seed+"}");
      g.shaderSource(S=g.createShader(g.FRAGMENT_SHADER),"precision mediump float;uniform float iGlobalTime, iFrame;uniform vec2 iResolution;void main(){"+seed.replace("fragColor", "gl_FragColor")+"}");

      // Compile and attach it to the program
      g.compileShader(S);
      g.attachShader(P,S);

      // Link and start the program
      g.linkProgram(P);
      g.useProgram(P);

      // Define a big triangle the canvas, containing the viewport
      g.bindBuffer(B=g.ARRAY_BUFFER,g.createBuffer());
      g.enableVertexAttribArray(0);
      g.vertexAttribPointer(0,2,g.BYTE,0,0,0);
      g.bufferData(B,new Int8Array([-3,1,1,-3,1,1]),g.STATIC_DRAW);

      // Main loop
      T=0;
      F=0;

      // Main loop
      (L=function(){
      
        // Current playback time
        g.uniform1f(g.getUniformLocation(P,"iGlobalTime"),T+=.016);
        
        // Current playback frame
        g.uniform1f(g.getUniformLocation(P,"iFrame"),F++);
        
        // Viewport resolution
        g.uniform2f(g.getUniformLocation(P,"iResolution"),640,360);
        
        // Draw
        g.drawArrays(g.TRIANGLE_FAN,0,3);
        
        // Next frame
        requestAnimationFrame(L);
      })();
    }
  }
</script>
